name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  manual-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
        
    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          echo "âŒ ç‰ˆæœ¬æ ¼å¼é”™è¯¯ã€‚è¯·ä½¿ç”¨ v1.0.0 æ ¼å¼"
          exit 1
        fi
        echo "âœ… ç‰ˆæœ¬æ ¼å¼æ­£ç¡®: $VERSION"
        
    - name: Build binaries
      run: |
        VERSION="${{ github.event.inputs.version }}"
        mkdir -p release
        
        LDFLAGS="-X main.version=${VERSION} -s -w"
        echo "æž„å»ºå‚æ•°: ${LDFLAGS}"
        
        # æž„å»ºæ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        platforms=(
          "linux/amd64"
          "linux/arm64" 
          "darwin/amd64"
          "darwin/arm64"
          "windows/amd64"
        )
        
        for platform in "${platforms[@]}"; do
          os=${platform%/*}
          arch=${platform#*/}
          
          echo "ðŸ”¨ æž„å»º server for ${os}/${arch}..."
          if [ "$os" = "windows" ]; then
            GOOS=$os GOARCH=$arch go build -ldflags="${LDFLAGS}" -o release/ctrans-server-${os}-${arch}.exe ./server
          else
            GOOS=$os GOARCH=$arch go build -ldflags="${LDFLAGS}" -o release/ctrans-server-${os}-${arch} ./server
          fi
          
          echo "ðŸ”¨ æž„å»º client for ${os}/${arch}..."  
          if [ "$os" = "windows" ]; then
            GOOS=$os GOARCH=$arch go build -ldflags="${LDFLAGS}" -o release/ctrans-${os}-${arch}.exe ./client
          else
            GOOS=$os GOARCH=$arch go build -ldflags="${LDFLAGS}" -o release/ctrans-${os}-${arch} ./client
          fi
        done
        
        # é‡å‘½åä¸ºå‹å¥½çš„æ–‡ä»¶å
        mv release/ctrans-server-darwin-amd64 release/ctrans-server-macos-amd64
        mv release/ctrans-server-darwin-arm64 release/ctrans-server-macos-arm64
        mv release/ctrans-darwin-amd64 release/ctrans-macos-amd64
        mv release/ctrans-darwin-arm64 release/ctrans-macos-arm64
        
    - name: Create checksums
      run: |
        cd release
        sha256sum * > checksums.txt
        echo "ðŸ“‹ æ ¡éªŒå’Œæ–‡ä»¶:"
        cat checksums.txt
        
    - name: List built files
      run: |
        echo "ðŸ“¦ æž„å»ºå®Œæˆçš„æ–‡ä»¶:"
        ls -lah release/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: ctrans ${{ github.event.inputs.version }}
        prerelease: ${{ github.event.inputs.prerelease }}
        generate_release_notes: true
        body: |
          # ctrans ${{ github.event.inputs.version }}
          
          ðŸš€ **è¿™æ˜¯ä¸€ä¸ª${{ github.event.inputs.prerelease == 'true' && 'é¢„å‘å¸ƒ' || 'æ­£å¼å‘å¸ƒ' }}ç‰ˆæœ¬**
          
          ## ðŸ“¦ ä¸‹è½½é“¾æŽ¥
          
          ### æœåŠ¡å™¨ç«¯
          | å¹³å° | æž¶æž„ | ä¸‹è½½é“¾æŽ¥ |
          |------|------|----------|
          | Linux | x86-64 | [ctrans-server-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-server-linux-amd64) |
          | Linux | ARM64 | [ctrans-server-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-server-linux-arm64) |
          | macOS | x86-64 | [ctrans-server-macos-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-server-macos-amd64) |
          | macOS | ARM64 | [ctrans-server-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-server-macos-arm64) |
          | Windows | x86-64 | [ctrans-server-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-server-windows-amd64.exe) |
          
          ### å®¢æˆ·ç«¯
          | å¹³å° | æž¶æž„ | ä¸‹è½½é“¾æŽ¥ |
          |------|------|----------|
          | Linux | x86-64 | [ctrans-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-linux-amd64) |
          | Linux | ARM64 | [ctrans-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-linux-arm64) |
          | macOS | x86-64 | [ctrans-macos-amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-macos-amd64) |
          | macOS | ARM64 | [ctrans-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-macos-arm64) |
          | Windows | x86-64 | [ctrans-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ctrans-windows-amd64.exe) |
          
          ## ðŸ” å®‰å…¨éªŒè¯
          
          ä¸‹è½½ [checksums.txt](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/checksums.txt) éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ```bash
          # å¯åŠ¨æœåŠ¡å™¨
          ./ctrans-server-linux-amd64 -port 9000 -key "your-secret-key"
          
          # ä½¿ç”¨å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶
          ./ctrans-linux-amd64 myfile.txt server:9000
          
          # è®¿é—®ç½‘é¡µç•Œé¢
          # http://server:9000
          ```
          
          ---
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Summary
      run: |
        echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**ç±»åž‹**: ${{ github.event.inputs.prerelease == 'true' && 'é¢„å‘å¸ƒç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY
        echo "**å‘å¸ƒé“¾æŽ¥**: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la release/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY 