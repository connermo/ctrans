name: Release

on:
  push:
    tags:
      - 'v*'  # æŽ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚v1.0.0

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
        
    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Build binaries
      run: |
        # åˆ›å»ºreleaseç›®å½•
        mkdir -p release
        
        # è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
        VERSION=${{ steps.version.outputs.VERSION }}
        LDFLAGS="-X main.version=${VERSION} -s -w"
        
        # æž„å»ºæœåŠ¡å™¨ç«¯äºŒè¿›åˆ¶æ–‡ä»¶
        echo "Building server binaries..."
        
        # Linux x86-64
        GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-server-linux-amd64 ./server
        
        # Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o release/ctrans-server-linux-arm64 ./server
        
        # macOS x86-64
        GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-server-macos-amd64 ./server
        
        # macOS ARM64 (Apple Silicon)
        GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o release/ctrans-server-macos-arm64 ./server
        
        # Windows x86-64
        GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-server-windows-amd64.exe ./server
        
        # æž„å»ºå®¢æˆ·ç«¯äºŒè¿›åˆ¶æ–‡ä»¶
        echo "Building client binaries..."
        
        # Linux x86-64
        GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-linux-amd64 ./client
        
        # Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o release/ctrans-linux-arm64 ./client
        
        # macOS x86-64
        GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-macos-amd64 ./client
        
        # macOS ARM64 (Apple Silicon)
        GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o release/ctrans-macos-arm64 ./client
        
        # Windows x86-64
        GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o release/ctrans-windows-amd64.exe ./client
        
    - name: Create checksums
      run: |
        cd release
        sha256sum * > checksums.txt
        
    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # ctrans ${VERSION}
        
        ## ðŸ“¦ ä¸‹è½½
        
        ### æœåŠ¡å™¨ç«¯
        - **Linux x86-64**: ctrans-server-linux-amd64
        - **Linux ARM64**: ctrans-server-linux-arm64  
        - **macOS x86-64**: ctrans-server-macos-amd64
        - **macOS ARM64**: ctrans-server-macos-arm64
        - **Windows x86-64**: ctrans-server-windows-amd64.exe
        
        ### å®¢æˆ·ç«¯
        - **Linux x86-64**: ctrans-linux-amd64
        - **Linux ARM64**: ctrans-linux-arm64
        - **macOS x86-64**: ctrans-macos-amd64  
        - **macOS ARM64**: ctrans-macos-arm64
        - **Windows x86-64**: ctrans-windows-amd64.exe
        
        ## ðŸš€ ä½¿ç”¨æ–¹æ³•
        
        ### å¯åŠ¨æœåŠ¡å™¨
        \`\`\`bash
        # Linux/macOS
        ./ctrans-server-linux-amd64 -port 9000 -key "your-secret-key"
        
        # Windows
        ctrans-server-windows-amd64.exe -port 9000 -key "your-secret-key"
        \`\`\`
        
        ### ä½¿ç”¨å®¢æˆ·ç«¯
        \`\`\`bash
        # ä¸Šä¼ æ–‡ä»¶
        ./ctrans-linux-amd64 myfile.txt server:9000
        
        # ä¸‹è½½æ–‡ä»¶  
        ./ctrans-linux-amd64 server:9000/myfile.txt
        
        # åˆ—å‡ºæ–‡ä»¶
        ./ctrans-linux-amd64 server:9000
        \`\`\`
        
        ### ç½‘é¡µç•Œé¢
        
        è®¿é—® http://server:9000 ä½¿ç”¨ç½‘é¡µä¸Šä¼ ç•Œé¢ï¼Œæ”¯æŒï¼š
        - ðŸ” å¯†é’¥è®¤è¯
        - ðŸ“ ç›®å½•ä¸Šä¼ 
        - ðŸŽ¯ æ‹–æ‹½ä¸Šä¼ 
        - ðŸ“Š å®žæ—¶è¿›åº¦
        - ðŸ“‹ æ–‡ä»¶åˆ—è¡¨
        
        ## ðŸ” å®‰å…¨éªŒè¯
        
        å¯ä»¥é€šè¿‡ checksums.txt éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
        \`\`\`bash
        sha256sum -c checksums.txt
        \`\`\`
        
        ---
        
        è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒ [README.md](https://github.com/\${{ github.repository }}/blob/main/README.md)
        EOF
        
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: ctrans ${{ steps.version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        
    - name: Upload Release Assets
      run: |
        # ä¸Šä¼ æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
        for file in release/*; do
          if [ -f "$file" ]; then
            echo "Uploading $file..."
            gh release upload ${{ steps.version.outputs.VERSION }} "$file" --clobber
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update latest release
      run: |
        echo "âœ… Release ${{ steps.version.outputs.VERSION }} created successfully!"
        echo "ðŸ“¦ Binaries uploaded for multiple platforms"
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}" 